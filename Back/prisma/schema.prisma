generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model app_user {
  user_id       BigInt    @id(map: "pk_app_user") @default(autoincrement())
  person_id     BigInt
  role_id       Int
  password_hash String    @db.VarChar(255)
  deleted_at    DateTime? @db.Timestamptz(6)
  person        person    @relation(fields: [person_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_app_user_person")
  role          role      @relation(fields: [role_id], references: [role_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_app_user_role")

  @@index([person_id], map: "idx_app_user_person_id")
  @@index([role_id], map: "idx_app_user_role_id")
}

model client {
  client_id         BigInt              @id(map: "pk_client") @default(autoincrement())
  person_id         BigInt
  created_at        DateTime            @default(now()) @db.Timestamptz(6)
  person            person              @relation(fields: [person_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_client_person")
  client_membership client_membership[]

  @@index([person_id], map: "idx_client_person_id")
}

model client_membership {
  client_membership_id BigInt                   @id(map: "pk_client_membership") @default(autoincrement())
  client_id            BigInt
  membership_id        BigInt
  start_date           DateTime                 @db.Date
  status               client_membership_status @default(ACTIVE)
  agreed_price         Decimal                  @db.Decimal(10, 2)
  created_at           DateTime                 @default(now()) @db.Timestamptz(6)
  updated_at           DateTime                 @default(now()) @db.Timestamptz(6)
  client               client                   @relation(fields: [client_id], references: [client_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_client_membership_client")
  membership           membership               @relation(fields: [membership_id], references: [membership_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_client_membership_membership")
  payment              payment[]

  @@index([client_id], map: "idx_client_membership_client_id")
  @@index([membership_id], map: "idx_client_membership_membership_id")
}

model membership {
  membership_id     BigInt              @id(map: "pk_membership") @default(autoincrement())
  membership_name   String              @db.VarChar(100)
  description       String?
  price             Decimal             @db.Decimal(10, 2)
  duration_days     Int
  created_at        DateTime            @default(now()) @db.Timestamptz(6)
  client_membership client_membership[]
}

model payment {
  payment_id           BigInt            @id(map: "pk_payment") @default(autoincrement())
  client_membership_id BigInt
  payment_method_id    Int
  amount               Decimal           @db.Decimal(10, 2)
  paid_at              DateTime          @default(now()) @db.Timestamptz(6)
  created_at           DateTime          @default(now()) @db.Timestamptz(6)
  client_membership    client_membership @relation(fields: [client_membership_id], references: [client_membership_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_payment_client_membership")
  payment_method       payment_method    @relation(fields: [payment_method_id], references: [payment_method_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_payment_payment_method")

  @@index([client_membership_id], map: "idx_payment_client_membership_id")
  @@index([payment_method_id], map: "idx_payment_payment_method_id")
}

model payment_method {
  payment_method_id Int       @id(map: "pk_payment_method") @default(autoincrement())
  name              String    @db.VarChar(50)
  description       String?   @db.VarChar(255)
  payment           payment[]
}

model person {
  person_id  BigInt     @id(map: "pk_person") @default(autoincrement())
  first_name String     @db.VarChar(100)
  last_name  String     @db.VarChar(100)
  phone      String?    @db.VarChar(30)
  email      String     @unique(map: "uq_person_email") @db.VarChar(255)
  created_at DateTime   @default(now()) @db.Timestamptz(6)
  app_user   app_user[]
  client     client[]
}

model role {
  role_id     Int        @id(map: "pk_role") @default(autoincrement())
  name        String     @db.VarChar(50)
  description String?    @db.VarChar(255)
  app_user    app_user[]
}

enum client_membership_status {
  ACTIVE
  PAUSED
  CANCELLED
}
